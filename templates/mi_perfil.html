{% extends 'base.html' %}
{% block navbar %}
    {% include 'navbar.html' %}
{% endblock %}
{% block content %}
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-xl shadow-lg p-6 text-center relative">
            <div class="flex justify-center">
                {% if user.foto_perfil %}
                    <img src="{{ user.foto_perfil.url }}" alt="Foto de perfil"
                         class="w-32 h-32 rounded-full object-cover border-4 border-blue-500 shadow-md">
                {% else %}
                    <div class="w-32 h-32 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 text-4xl border-4 border-gray-300 shadow-md">
                        <i class="fa-solid fa-user"></i>
                    </div>
                {% endif %}
            </div>

            <h1 class="text-2xl font-bold text-gray-800 mt-4">{{ user.first_name }} {{ user.last_name }}</h1>
            <p class="text-gray-600">@{{ user.username }}</p>
            <p class="text-sm text-gray-500">{{ user.email }}</p>

            {% if user.descripcion %}
                <p class="mt-4 text-gray-700 italic">"{{ user.descripcion }}"</p>
            {% else %}
                <p class="mt-4 text-gray-400 italic">Sin descripción</p>
            {% endif %}

            <div class="mt-4">
                {% if user.visible %}
                    <span class="px-3 py-1 text-sm rounded-full bg-green-100 text-green-700">
                        <i class="fa-solid fa-eye mr-1"></i> Público
                    </span>
                {% else %}
                    <span class="px-3 py-1 text-sm rounded-full bg-red-100 text-red-700">
                        <i class="fa-solid fa-eye-slash mr-1"></i> Privado
                    </span>
                {% endif %}
            </div>

            <div class="mt-6">
                <button id="editarBtn"
                   class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
                    <i class="fa-solid fa-user-pen mr-1"></i> Editar Perfil
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Perfil -->
    <div id="editarModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <!-- Contenedor con scroll si el contenido excede -->
        <div class="bg-white rounded-lg shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 relative">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Editar Perfil</h2>
    
            <form method="post" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                
                <!-- Nombre -->
                <div>
                    <label class="block text-gray-700 font-medium">Nombre</label>
                    <input type="text" name="first_name" value="{{ user.first_name }}"
                           class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring focus:ring-blue-300">
                </div>
    
                <!-- Apellido -->
                <div>
                    <label class="block text-gray-700 font-medium">Apellido</label>
                    <input type="text" name="last_name" value="{{ user.last_name }}"
                           class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring focus:ring-blue-300">
                </div>
    
                <!-- Correo -->
                <div>
                    <label class="block text-gray-700 font-medium">Correo electrónico</label>
                    <input type="email" name="email" value="{{ user.email }}"
                           class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring focus:ring-blue-300">
                </div>
    
                <!-- Descripción -->
                <div>
                    <label class="block text-gray-700 font-medium">Descripción</label>
                    <textarea name="descripcion" rows="3"
                              class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring focus:ring-blue-300">{{ user.descripcion }}</textarea>
                </div>
    
                <!-- Foto de perfil -->
                <div>
                    <label class="block text-gray-700 font-medium">Foto de perfil</label>
                    <input id="fileInput" type="file" name="foto_perfil" accept="image/*"
                           class="w-full mt-1 px-3 py-2 border rounded-lg focus:ring focus:ring-blue-300">
    
                    <!-- Área de previsualización para recorte -->
                    <div class="mt-4 flex justify-center">
                        <img id="preview" class="max-w-full max-h-64 rounded-lg shadow-md hidden" />
                    </div>
    
                    <!-- Campo oculto donde se guardará la imagen recortada -->
                    <input type="hidden" name="foto_perfil_cropped" id="croppedImage">
                </div>
    
                <!-- Perfil público -->
                <div class="flex items-center">
                    <input type="checkbox" name="visible" id="visible"
                           {% if user.visible %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="visible" class="ml-2 text-gray-700">Perfil público</label>
                </div>
    
                <!-- Botones -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cerrarModal"
                            class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
                        Guardar cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Abrir modal
        document.getElementById('editarBtn').addEventListener('click', function () {
            document.getElementById('editarModal').classList.remove('hidden');
        });

        // Cerrar modal
        document.getElementById('cerrarModal').addEventListener('click', function () {
            document.getElementById('editarModal').classList.add('hidden');
        });

        // Cerrar modal al hacer click fuera
        window.addEventListener('click', function(e) {
            let modal = document.getElementById('editarModal');
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
        
        let cropper;
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const croppedImage = document.getElementById('croppedImage');
    
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove("hidden");
    
                    // Si ya existe un cropper previo, lo destruimos
                    if (cropper) {
                        cropper.destroy();
                    }
    
                    // Iniciamos Cropper.js
                    cropper = new Cropper(preview, {
                        aspectRatio: 1, // cuadrado (ideal para perfil)
                        viewMode: 1,
                        movable: false,
                        zoomable: true,
                        rotatable: false,
                        scalable: false,
                        background: false,
                        autoCropArea: 1,
                    });
                };
                reader.readAsDataURL(file);
            }
        });
    
        // Antes de enviar el formulario recortamos la imagen
        document.querySelector("form").addEventListener("submit", function (e) {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({
                    width: 300, // tamaño final (px)
                    height: 300,
                });
                croppedImage.value = canvas.toDataURL("image/png"); // Guardamos en base64
            }
        });
    </script>
{% endblock %}
